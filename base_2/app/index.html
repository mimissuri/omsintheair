<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="assets/leaflet.css">
    <title>OmsInTheAir</title>
</head>

<body class="alcentre">
    <div class="motorpow">
        <div class="motorpowbar" id="leftmotor"></div>
    </div>
    <div style="height: 100vh; width: 98vw">
        <div class="topbar"></div>
        <div class="header alcentre">
            <input type="text" class="commands" placeholder="Write command" id="input1">
            <div class="commbut alcentre" onclick="commbutf(0)">Vibing</div>
            <div class="commbut alcentre" onclick="commbutf(1)">Steady</div>
            <div class="commbut alcentre" onclick="commbutf(2)">Ready</div>
            <div class="commbut alcentre" onclick="commbutf(3)">Base Control</div>
            <div class="commbutr alcentre" onclick="commbutf(99)">Reboot</div>
        </div>

        <div class="data alcentre">
            <div class="logs">
                <!-- GLOBAL -->
                <div class="alcentre"
                    style="background-color: rgb(0, 0, 0); border: 1px solid rgb(26, 21, 49); border-radius:5px;">

                    <div class="delokos">
                        <div class="alcentre nene">Pitch G</div>
                        <div id="pg" class="alcentre datos" style="border-bottom-left-radius: 5px; ">-</div>
                    </div>
                    <div class="delokos">
                        <div class="alcentre nene">Roll G</div>
                        <div id="rg" class="alcentre datos">-</div>
                    </div>
                    <div class="delokos">
                        <div class="alcentre nene">Yaw G</div>
                        <div id="yg" class="alcentre datos" style="border-bottom-right-radius: 5px; ">-</div>
                    </div>
                </div><!-- MPU1 -->
                <div class="alcentre"
                    style="background-color: rgb(18, 45, 59); border: 1px solid rgb(26, 21, 49); border-radius:5px;margin-top: 1.75vh;">

                    <div class="delokos">
                        <div class="alcentre nene">Pitch 1</div>
                        <div id="p1" class="alcentre datos" style="border-bottom-left-radius: 5px; ">-</div>
                    </div>
                    <div class="delokos">
                        <div class="alcentre nene">Roll 1</div>
                        <div id="r1" class="alcentre datos">-</div>
                    </div>
                    <div class="delokos">
                        <div class="alcentre nene">Yaw 1</div>
                        <div id="y1" class="alcentre datos" style="border-bottom-right-radius: 5px; ">-</div>
                    </div>
                </div>
                <!-- MPU2 -->
                <div class="alcentre"
                    style="background-color: rgb(19, 54, 27); border: 1px solid rgb(26, 21, 49); border-radius:5px;margin-top: 1.75vh;">

                    <div class="delokos">
                        <div class="alcentre nene">Pitch 2</div>
                        <div id="p2" class="alcentre datos" style="border-bottom-left-radius: 5px; ">-</div>
                    </div>
                    <div class="delokos">
                        <div class="alcentre nene">Roll 2</div>
                        <div id="r2" class="alcentre datos">-</div>
                    </div>
                    <div class="delokos">
                        <div class="alcentre nene">Yaw 2</div>
                        <div id="y2" class="alcentre datos" style="border-bottom-right-radius: 5px; ">-</div>
                    </div>
                </div>
                <!-- MPU3 -->
                <div class="alcentre"
                    style="background-color: rgb(66, 28, 27); border: 1px solid rgb(26, 21, 49); border-radius:5px;margin-top: 1.75vh;">

                    <div class="delokos">
                        <div class="alcentre nene">Pitch 3</div>
                        <div id="p3" class="alcentre datos" style="border-bottom-left-radius: 5px; ">-</div>
                    </div>
                    <div class="delokos">
                        <div class="alcentre nene">Roll 3</div>
                        <div id="r3" class="alcentre datos">-</div>
                    </div>
                    <div class="delokos">
                        <div class="alcentre nene">Yaw 3</div>
                        <div id="y3" class="alcentre datos" style="border-bottom-right-radius: 5px; ">-</div>
                    </div>
                </div>
            </div>
            <div class="map" id="map_id"></div>
        </div>

        <div class="motors alcentre">
            <div class="motor alcentre">
                <div>
                    <div class="percentatge" id="pm_l">
                        -
                    </div>
                    <div class="rpm">L</div>
                </div>
            </div>
            <div class="angle alcentre" id="m1servo">-</div>
            <div class="spacer" id="spacer">
                <div class="alcentre" style="font-size: 12px;">PI:&nbsp<a
                        id="pi">-</a>&nbsp&nbsp||&nbsp&nbspMode:&nbsp<a id="moderrimo">-</a>
                </div>
                <div id="stl_cont" style="width:100%;height:100%;margin-left:5%;" class="avionsito"></div>
            </div>
            <div class="angle alcentre" id="m2servo">-</div>
            <div class="motor alcentre">
                <div>
                    <div class="percentatge" id="pm_r">
                        -
                    </div>
                    <div class="rpm">R</div>
                </div>
            </div>
        </div>
        <div class="servos alcentre">
            <div class="servo">L-Wing <div class="rservo alcentre" id="s0">-</div>
            </div>
            <div class="servo">Package<div class="rservo alcentre" id="s2">-</div>
            </div>
            <div class="servo">V-Elevator<div class="rservo alcentre" id="s3">-</div>
            </div>
            <div class="servo">H-Elevator<div class="rservo alcentre" id="s4">-</div>
            </div>
            <div class="servo">R-Wing<div class="rservo alcentre" id="s1">-</div>
            </div>
        </div>
        <div class="motorpowh alcentre">
            <div class="motorpowbarh" id="waybar"></div>
        </div>
    </div>
    <div class="motorpow">
        <div class="motorpowbar" id="rightmotor"></div>
    </div>
</body>
<script src="assets/jquery.js"></script>
<script src="stl_render/stl_viewer.min.js"></script>
<script>

    var pitch_m1 = 0;
    var pitch_m2 = 0;
    var pitch_m3 = 0;
    var pitch_gi = 0;
    var roll_m1 = 0;
    var roll_m2 = 0;
    var roll_m3 = 0;
    var roll_gi = 0;
    var yaw_m1 = 0;
    var yaw_m2 = 0;
    var yaw_m3 = 0;
    var yaw_gi = 0;
    var stl_viewer = new StlViewer(
        document.getElementById("stl_cont"), {
        allow_drag_and_drop: false,
        models: [{
            id: 0,
            filename: "yeye.STL",
            opacity: 0.8,
            z: 1,
            color: "#000",
            view_edges: true
        }, {
            id: 1,
            filename: "yeye.STL",
            opacity: 0.5,
            z: 1,
            color: "#122D3B",
        }, {
            id: 2,
            filename: "yeye.STL",
            opacity: 0.5,
            z: 1,
            color: "#13361B",
        }, {
            id: 3,
            filename: "yeye.STL",
            opacity: 0.5,
            z: 1,
            color: "#421C1B",
        },]
    }
    );
</script>
<script src="assets/leaflet.js"></script>
<script src="assets/maps.js"></script>
<script src="assets/socketio.js"></script>
<script>
    var mode = 0;
    var socket = io("http://localhost:3000");
    setTimeout(function () {
        socket.on('planedata', function (msg) {
            stl_viewer.rotate(0, 0, msg["yaw_gi"] - yaw_gi, 0);
            stl_viewer.rotate(1, msg["pitch_m1"] - pitch_m1, 0, msg["roll_m1"] - roll_m1);
            stl_viewer.rotate(2, msg["pitch_m2"] - pitch_m2, 0, msg["roll_m2"] - roll_m2);
            stl_viewer.rotate(3, msg["pitch_m3"] - pitch_m3, 0, msg["roll_m3"] - roll_m3);

            pitch_m1 = msg["pitch_m1"];
            pitch_m2 = msg["pitch_m2"];
            pitch_m3 = msg["pitch_m3"];
            pitch_gi = msg["pitch_gi"];
            roll_m1 = msg["roll_m1"];
            roll_m2 = msg["roll_m2"];
            roll_m3 = msg["roll_m3"];
            roll_gi = msg["roll_gi"];
            yaw_m1 = msg["yaw_m1"];
            yaw_m2 = msg["yaw_m2"];
            yaw_m3 = msg["yaw_m3"];
            yaw_gi = msg["yaw_gi"];

            document.getElementById("pg").innerHTML = msg["pitch_gi"];
            document.getElementById("rg").innerHTML = msg["roll_gi"];
            document.getElementById("yg").innerHTML = msg["yaw_gi"];

            document.getElementById("p1").innerHTML = msg["pitch_m1"];
            document.getElementById("r1").innerHTML = msg["roll_m1"];
            document.getElementById("y1").innerHTML = msg["yaw_m1"];

            document.getElementById("p2").innerHTML = msg["pitch_m2"];
            document.getElementById("r2").innerHTML = msg["roll_m2"];
            document.getElementById("y2").innerHTML = msg["yaw_m2"];

            document.getElementById("p3").innerHTML = msg["pitch_m3"];
            document.getElementById("r3").innerHTML = msg["roll_m3"];
            document.getElementById("y3").innerHTML = msg["yaw_m3"];

            document.getElementById("pi").innerHTML = msg["pi"];
            document.getElementById("moderrimo").innerHTML = mode;

            document.getElementById("m1servo").innerHTML = parseFloat(msg["s_l"]).toFixed(1) + "º";
            document.getElementById("m2servo").innerHTML = parseFloat(msg["s_r"]).toFixed(1) + "º";

            document.getElementById("pm_l").innerHTML = parseFloat(msg["m_l"]).toFixed(1);
            document.getElementById("pm_r").innerHTML = parseFloat(msg["m_r"]).toFixed(1);

            document.getElementById("s0").innerHTML = parseFloat(msg["s0"]).toFixed(1);
            document.getElementById("s1").innerHTML = parseFloat(msg["s1"]).toFixed(1);
            document.getElementById("s2").innerHTML = parseFloat(msg["s2"]).toFixed(1);
            document.getElementById("s3").innerHTML = parseFloat(msg["s3"]).toFixed(1);
            document.getElementById("s4").innerHTML = parseFloat(msg["s4"]).toFixed(1);
        });
    }, 1000);

    //La següent funció s'encarrega de que quan es clica intro en el input envia l'ordre a el backend
    var input = document.getElementById("input1");
    input.addEventListener('keyup', function (e) {
        if (e.key === 'Enter' || e.keyCode === 13) {
            ipcRenderer.send('command', input.value);
            if (input.value == "stop_stream") {
                document.getElementById("logs").style.display = "block";
                document.getElementById("imgstream").style.display = "none";

            }
            input.value = "";
        }
    });

    function commbutf(value) {
        mode = value;
        socket.emit('commbuts', value);
    }
    // Creem les variables globals que necessitarem
    var caliblx = 0;
    var calibly = 0;
    var calibrx = 0;
    var calibry = 0;
    var lx = 0;
    var ly = 0;
    var rx = 0;
    var ry = 0;

    //Escoltem per quan es detecti el gamepad o mando
    window.addEventListener('gamepadconnected', (event) => {
        console.log("Gamepads: " + navigator.getGamepads());
        const update = () => {
            // Agafem tota la informació actual del mando
            var gp = navigator.getGamepads()[0];

            // Repartim la informació en variables per a que sigui més comode de treballar
            var b_x = gp.buttons[0];
            var b_r = gp.buttons[1];
            var b_c = gp.buttons[2];
            var b_t = gp.buttons[3];
            var l1 = gp.buttons[4];
            var l2 = gp.buttons[6];
            var r1 = gp.buttons[5];
            var r2 = gp.buttons[7];
            var up = gp.buttons[12];
            var down = gp.buttons[13];
            var left = gp.buttons[14];
            var right = gp.buttons[15];
            var start = gp.buttons[8];
            var select = gp.buttons[9];

            var aLX = gp.axes[2] - caliblx;
            var aLY = gp.axes[3] - calibly;

            var aRX = gp.axes[2] - calibrx;
            var aRY = gp.axes[3] - calibry;
            rx += +aRX;
            if (r1.pressed) {
                // Sumem el valor a la global sempre assegurant que no sobrepassa els limits
                ly += +aLY * -0.5;
                if (ly < 0) {
                    ly = 0
                }
                if (ly > 100) {
                    ly = 100
                }
                aLX = 0
            }
            if (up.pressed) {
                // Fem que no tingiu cap valor
                ly = 0;
            }
            if (l1.pressed) {
                // Sumem el valor a la global sempre assegurant que no sobrepassa els limits
                ly += +aLY * -5;
                if (ly < 0) {
                    ly = 0
                }
                if (ly > 100) {
                    ly = 100
                }
                aLX = 0
            }
            if (down.pressed) {
                // Fem que no tingiu cap valor
                aLX = 0;
            }
            //Mostrem els nous valors en pantalla
            document.getElementById("rightmotor").style.height = ly + "%";
            document.getElementById("leftmotor").style.height = ly + "%";

            document.getElementById("waybar").style.width = Math.abs(aLX) * 50 + "%";
            document.getElementById("waybar").style.marginLeft = (aLX) * 50 + "%";
            var client = {
                "mode": mode,
                "m_l": ly,
                "m_r": ly,
                "s0": 0,
                "s1": 0,
                "s2": 0,
                "s3": 0,
                "s4": 0,
                "s_l": aLX * 30,
                "s_r": aLX * -30,
            };
            console.log(ly);
            socket.emit("data", client)

            //Tornem a l'inici

            requestAnimationFrame(update);
        };
        update();
    });
</script>

</html>